name: CI
on: push

jobs:
  build:

    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
    - name: Make envfile
      uses: SpicyPizza/create-envfile@v1
      with:
        envkey_DB_HOST: db_dev
        envkey_DB_PORT: 5432
        envkey_DB_NAME: bkmps-dev
        envkey_DB_USER: postgres-dev
        envkey_DB_PASSWORD: postgres-dev
        envkey_DB_TEST_HOST: db_test
        envkey_DB_TEST_PORT: 5432
        envkey_DB_TEST_NAME: bkmps-test
        envkey_DB_TEST_USER: postgres-test
        envkey_DB_TEST_PASSWORD: postgres-test
    - run: docker-compose -f .devcontainer/docker-compose.yml up -d
    - run: docker-compose -f .devcontainer/docker-compose.yml exec -T app /bin/sh -c "cd /workspace; npm ci"
    - run: docker-compose -f .devcontainer/docker-compose.yml exec -T app /bin/sh -c "cd /workspace; npm run lint"
    - run: docker-compose -f .devcontainer/docker-compose.yml exec -T app /bin/sh -c "cd /workspace; npm run build"
    - run: docker-compose -f .devcontainer/docker-compose.yml exec -T app /bin/sh -c "cd /workspace; npm run test:cov"
    - run: docker-compose -f .devcontainer/docker-compose.yml exec -T app /bin/sh -c "cd /workspace; npm run test:e2e"
    - run: docker-compose -f .devcontainer/docker-compose.yml down